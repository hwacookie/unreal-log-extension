<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unreal Log Viewer</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            color: var(--vscode-editor-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Use full viewport height */
        }
        #filter-controls {
            padding: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
            background-color: var(--vscode-sideBar-background, #252526);
        }
        #filter-controls label {
            font-size: var(--vscode-font-size);
        }
        #filter-controls input[type="text"] {
            font-family: var(--vscode-font-family);
            color: var(--vscode-input-foreground);
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            padding: 4px;
            font-size: var(--vscode-font-size);
            flex-grow: 1;
            min-width: 80px;
        }
        #filter-controls button {
            font-family: var(--vscode-font-family);
            color: var(--vscode-button-foreground);
            background-color: var(--vscode-button-background);
            border: 1px solid var(--vscode-button-border);
            padding: 4px 8px;
            cursor: pointer;
            font-size: var(--vscode-font-size);
        }
        #filter-controls button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        #log-table-container {
            flex-grow: 1; /* Takes remaining space */
            overflow-y: auto; /* Enables scrolling for the table container */
            padding-top: 5px; /* Increased from 2px to ensure topmost row isn't visually cut */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        td {
            border: 1px solid var(--vscode-contrastBorder, #555);
            padding: 6px;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: var(--log-table-font-size, var(--vscode-font-size));
            font-family: var(--log-table-font-family, var(--vscode-font-family)); /* Apply font family, default to vscode-font-family */
        }

        /* Grid lines control */
        body.no-grid-lines td {
            border: none;
        }

        thead th, .col-src, .col-date, .col-level, .col-category, .col-message {
            text-align: left;
        }

        .col-date, .col-level, .col-category {
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .col-date { width: fit-content; } /* Adjusted for content-based width */
        .col-level { width: fit-content; } /* Adjusted for content-based width */
        .col-category { width: fit-content; } /* Adjusted for content-based width */
        .col-message {
            white-space: pre-wrap;
            word-break: break-all;
        }
        .col-src {
            width: 2.5em;
            min-width: 2.5em;
            max-width: 3em;
            text-align: center;
            font-weight: bold;
            color: #888;
            background: inherit;
            letter-spacing: 0.05em;
        }
        /* Updated and Extended Log Level Colors */
        .level-FATAL { color: #FF00FF; }       /* Fuchsia/Magenta */
        .level-ERROR { color: #FF5555; }       /* Red */
        .level-WARNING { color: #FFD700; }     /* Yellow */
        .level-DISPLAY { color: var(--vscode-textLink-foreground, #87CEFA); } /* VSCode Link or Light Sky Blue */
        /* .level-LOG will use default foreground color if not specified */
        .level-VERBOSE { color: #BBBBBB; }     /* Light Gray */
        .level-VERYVERBOSE { color: #999999; } /* Dimmer Gray */

        .date { color: #3CB371; } /* MediumSeaGreen - less bright green */

        /* Overrides when custom colors are disabled */
        body.no-custom-colors .level-FATAL,
        body.no-custom-colors .level-ERROR,
        body.no-custom-colors .level-WARNING,
        body.no-custom-colors .level-DISPLAY,
        body.no-custom-colors .level-LOG, /* Ensure .level-LOG is also reset if it had a color or inherits differently */
        body.no-custom-colors .level-VERBOSE,
        body.no-custom-colors .level-VERYVERBOSE,
        body.no-custom-colors .date {
            color: var(--vscode-editor-foreground);
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center; /* Align items vertically */
        }

        .filter-controls input[type="text"] {
            flex-grow: 1;
            padding: 5px;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
        }

        .filter-controls button {
            padding: 5px 10px;
            border: 1px solid var(--vscode-button-border, transparent);
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            cursor: pointer;
        }

        .filter-controls button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .log-counter { /* New: Style for the counter */
            white-space: nowrap; /* Prevent wrapping */
            margin: 0 5px; /* Add some spacing */
            min-width: 10%; /* Changed from 20% to 10% */
            text-align: right; /* Changed from center to right */
        }
    </style>
</head>
<body>
    <div id="filter-controls">
        <label for="levelFilterInput">Level:</label>
        <input type="text" id="levelFilterInput" name="levelFilterInput" title="Filter by log level. Examples:&#10;- 'Error,Warning' (shows Error or Warning)&#10;- '!Verbose' (hides Verbose)&#10;- '>Warning' (shows Warning, Error, Fatal)&#10;- 'Error,!LogTemp' (shows Error, hides LogTemp category if used with category filter)">
        <label for="categoryFilterInput">Category:</label>
        <input type="text" id="categoryFilterInput" name="categoryFilterInput" title="Filter by log category. Examples:&#10;- 'LogAI,LogNet' (shows LogAI or LogNet)&#10;- '!LogTemp' (hides LogTemp)&#10;- 'AI' (shows categories containing 'AI')&#10;- 'MyCat,!Internal' (shows MyCat, hides Internal)">
        <label for="messageFilterInput">Message:</label>
        <input type="text" id="messageFilterInput" name="messageFilterInput" title="Filter by log message content. Examples:&#10;- 'Player,Spawn' (message contains Player or Spawn)&#10;- '!Debug' (message does not contain Debug)&#10;- 'Error 123' (message contains 'Error 123')">
        <span id="logCounter" class="log-counter">0 / 0</span> <!-- New: Counter element -->
        <button id="clearFilterButton">Clear</button>
        <button id="copilotViewButton" title="Show current logs as a text document for GitHub Copilot">Copilot View</button> <!-- Added Copilot View Button -->
        <button id="pauseButton" title="Pause log updates in the view">Pause</button> <!-- Added Pause Button -->
    </div>

    <div id="log-table-container">
        <table> 
            <thead>
                <tr id="log-table-header-row">
                    <!-- Header cells will be inserted dynamically -->
                </tr>
            </thead>
            <tbody id="log-entries">
                <!-- Log entries will be dynamically inserted here -->
            </tbody>
        </table>
    </div>
    <script>
        const vscode = acquireVsCodeApi();
        const levelInput = document.getElementById('levelFilterInput');
        const categoryInput = document.getElementById('categoryFilterInput');
        const messageInput = document.getElementById('messageFilterInput'); // New
        const logCounter = document.getElementById('logCounter'); // New: Get counter element
        const clearButton = document.getElementById('clearFilterButton');
        const copilotViewButton = document.getElementById('copilotViewButton'); // Added: Get Copilot View button
        const pauseButton = document.getElementById('pauseButton'); // Added: Get Pause button
        const logEntriesTableBody = document.getElementById('log-entries');
        const logTableContainer = document.getElementById('log-table-container');

        let showSrcColumn = false;

        function applyFontSize(fontSize) {
            document.documentElement.style.setProperty('--log-table-font-size', fontSize);
        }

        function applyFontFamily(fontFamily) { // New function
            document.documentElement.style.setProperty('--log-table-font-family', fontFamily);
        }

        function applyColorMode(useColors) {
            if (useColors) {
                document.body.classList.remove('no-custom-colors');
            } else {
                document.body.classList.add('no-custom-colors');
            }
        }

        function applyGridLinesVisibility(showGridLines) {
            if (showGridLines) {
                document.body.classList.remove('no-grid-lines');
            } else {
                document.body.classList.add('no-grid-lines');
            }
        }

        function sanitize(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function updateTableHeader() {
            const headerRow = document.getElementById('log-table-header-row');
            headerRow.innerHTML = '';
            if (showSrcColumn) {
                const thSrc = document.createElement('th');
                thSrc.className = 'col-src';
                thSrc.textContent = 'SRC';
                headerRow.appendChild(thSrc);
            }
            const thDate = document.createElement('th'); thDate.className = 'col-date'; thDate.textContent = 'Date'; headerRow.appendChild(thDate);
            const thLevel = document.createElement('th'); thLevel.className = 'col-level'; thLevel.textContent = 'Level'; headerRow.appendChild(thLevel);
            const thCategory = document.createElement('th'); thCategory.className = 'col-category'; thCategory.textContent = 'Category'; headerRow.appendChild(thCategory);
            const thMessage = document.createElement('th'); thMessage.className = 'col-message'; thMessage.textContent = 'Message'; headerRow.appendChild(thMessage);
        }

        function logHasSource(log) {
            return (typeof log.source === 'string' && log.source.trim().length > 0) || (typeof log.src === 'string' && log.src.trim().length > 0);
        }

        function checkShowSrcColumn(logs) {
            return logs.some(logHasSource);
        }

        function createLogRowHtml(log) {
            const sanitizedLevel = sanitize(log.level.toUpperCase()); // Ensure consistent casing for class names
            const levelClass = 'level-' + sanitizedLevel; // e.g. level-FATAL, level-WARNING

            const dateHtml = sanitize(log.date);
            const levelHtml = sanitize(log.level); // Display original casing for the text content
            const categoryHtml = sanitize(log.category);
            const messageHtml = sanitize(log.message);
            let srcVal = (log.source || log.src || '');
            if (typeof srcVal === 'string') {
                srcVal = srcVal.substring(0, 3); // Truncate to max 3 chars
            }
            const srcHtml = sanitize(srcVal);

            let rowHtml = '<tr>';
            if (showSrcColumn) {
                rowHtml += `<td class="col-src">${srcHtml}</td>`;
            }
            rowHtml += `<td class="col-date date">${dateHtml}</td>`;
            rowHtml += `<td class="col-level ${levelClass}">${levelHtml}</td>`;
            rowHtml += `<td class="col-category">${categoryHtml}</td>`;
            rowHtml += `<td class="col-message">${messageHtml}</td>`;
            rowHtml += '</tr>';
            return rowHtml;
        }

        function createLogTableRow(log) {
            const row = document.createElement('tr');
            row.innerHTML = createLogRowHtml(log);
            return row;
        }

        function updateAllRows(logs) {
            logEntriesTableBody.innerHTML = '';
            logs.forEach(log => {
                logEntriesTableBody.appendChild(createLogTableRow(log));
            });
        }

        function shouldScrollToBottom() {
            return logTableContainer.scrollHeight - logTableContainer.scrollTop <= logTableContainer.clientHeight + 50;
        }

        function scrollToBottom() {
            logTableContainer.scrollTop = logTableContainer.scrollHeight;
        }
        
        // Store all logs for dynamic column logic
        let allLogs = [];

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'addLogEntry': {
                    allLogs.push(message.logEntry);
                    if (!showSrcColumn && logHasSource(message.logEntry)) {
                        showSrcColumn = true;
                        updateTableHeader();
                        updateAllRows(allLogs);
                        break;
                    }
                    const wasScrolledToBottom = shouldScrollToBottom();
                    const newRow = createLogTableRow(message.logEntry);
                    logEntriesTableBody.appendChild(newRow);
                    if (wasScrolledToBottom) {
                        scrollToBottom();
                    }
                    break;
                }
                case 'removeOldestLogs': {
                    const countToRemove = message.count;
                    allLogs.splice(0, countToRemove);
                    updateAllRows(allLogs);
                    break;
                }
                case 'setLogs': {
                    allLogs = message.logs.slice();
                    showSrcColumn = checkShowSrcColumn(allLogs);
                    updateTableHeader();
                    updateAllRows(allLogs);
                    const oldScrollTop = logTableContainer.scrollTop;
                    const oldScrollHeight = logTableContainer.scrollHeight;
                    const oldClientHeight = logTableContainer.clientHeight;
                    if (oldScrollHeight - oldScrollTop <= oldClientHeight + 50) {
                        scrollToBottom();
                    } else {
                        logTableContainer.scrollTop = oldScrollTop;
                    }
                    break;
                }
                case 'updateFilterInputs':
                    levelInput.value = message.levelFilter;
                    categoryInput.value = message.categoryFilter;
                    messageInput.value = message.messageFilter; // New
                    break;
                case 'updateCounts': // New: Handle count updates
                    logCounter.textContent = `${message.shown} / ${message.total}`;
                    break;
                case 'updateFontSize': // New: Handle font size updates
                    applyFontSize(message.fontSize);
                    break;
                case 'updateColorMode': // New: Handle color mode updates
                    applyColorMode(message.useColors);
                    break;
                case 'updateGridLinesVisibility': // New: Handle grid lines visibility updates
                    applyGridLinesVisibility(message.showGridLines);
                    break;
                case 'updateFontFamily': // New: Handle font family updates
                    applyFontFamily(message.fontFamily);
                    break;
                case 'updatePauseButton': // Added: Handle pause button text update
                    pauseButton.textContent = message.isPaused ? 'Resume' : 'Pause';
                    pauseButton.title = message.isPaused ? 'Resume log updates' : 'Pause log updates';
                    break;
            }
        });

        levelInput.addEventListener('input', () => {
            vscode.postMessage({
                command: 'applyFilters',
                levelFilter: levelInput.value,
                categoryFilter: categoryInput.value,
                messageFilter: messageInput.value // New
            });
        });

        categoryInput.addEventListener('input', () => {
            vscode.postMessage({
                command: 'applyFilters',
                levelFilter: levelInput.value,
                categoryFilter: categoryInput.value,
                messageFilter: messageInput.value // New
            });
        });

        messageInput.addEventListener('input', () => { // New
            vscode.postMessage({ // New
                command: 'applyFilters', // New
                levelFilter: levelInput.value, // New
                categoryFilter: categoryInput.value, // New
                messageFilter: messageInput.value // New
            }); // New
        }); // New

        clearButton.addEventListener('click', () => {
            vscode.postMessage({ command: 'webviewClearButtonPressed' });
        });

        copilotViewButton.addEventListener('click', () => { // Added: Event listener for Copilot View button
            vscode.postMessage({ command: 'copilotViewRequested' });
        });

        pauseButton.addEventListener('click', () => { // Added: Event listener for Pause button
            vscode.postMessage({ command: 'togglePause' });
        });

        vscode.postMessage({ command: 'getInitialLogs' });

    </script>
</body>
</html>
